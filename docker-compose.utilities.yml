
#########################
# Optional NAS Utilities #
#########################
# These services are useful but not required for the media stack.
# Deploy with: docker compose -f docker-compose.utilities.yml up -d

#########################
# Volumes               #
#########################
volumes:
  duc-index:
  uptime-kuma-data:

#########################
# Networks              #
#########################
networks:
  arr-stack:
    external: true

#########################
# Logging               #
#########################
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

#########################
# Services              #
#########################
services:
  # ═══════════════════════════════════════════════════════════════════════════
  # DEUNHEALTH - Auto-recovery for VPN failures. Watches gluetun health and
  # restarts dependent services (qBittorrent, Sonarr, etc.) when VPN recovers.
  # No web UI. Runs silently in background.
  # ═══════════════════════════════════════════════════════════════════════════
  deunhealth:
    image: qmcgaw/deunhealth
    container_name: deunhealth
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=${TZ:-Europe/London}
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD", "/app", "healthcheck"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ═══════════════════════════════════════════════════════════════════════════
  # UPTIME KUMA - Monitoring dashboard. Shows health of all your services.
  # Access: uptime.lan | NAS_IP:3001 (LAN-only, use WireGuard for remote)
  # ═══════════════════════════════════════════════════════════════════════════
  uptime-kuma:
    image: louislam/uptime-kuma:2
    container_name: uptime-kuma
    restart: always
    ports:
      - "3001:3001"  # Local network access only
    environment:
      - TZ=${TZ:-Europe/London}
    networks:
      arr-stack:
        ipv4_address: 172.20.0.13  # For monitoring other containers
    volumes:
      - uptime-kuma-data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro  # For Docker container monitoring
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "node /app/extra/healthcheck.js"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ═══════════════════════════════════════════════════════════════════════════
  # DUC - Disk usage analyzer. Visual treemap UI showing what's using storage.
  # Access: duc.lan | NAS_IP:8838 (LAN-only, use WireGuard for remote)
  # Note: Re-indexes daily at 4am. Manual: docker restart duc
  # ═══════════════════════════════════════════════════════════════════════════
  duc:
    image: mkoestler/duc-service:latest
    container_name: duc
    networks:
      arr-stack:
        ipv4_address: 172.20.0.14
    volumes:
      - /volume1:/scan/volume1:ro      # NAS data (read-only)
      - duc-index:/database            # Persistent index
    ports:
      - "8838:80"                      # Local network access only
    environment:
      - TZ=${TZ:-Europe/London}
      - SCHEDULE=0 4 * * *             # Re-index daily at 4am
    restart: always
    logging: *default-logging

  # ═══════════════════════════════════════════════════════════════════════════
  # QBIT-SCHEDULER - Pauses torrents overnight to let disks spin down.
  # Default: pause at 20:00, resume at 06:00. No web UI.
  # ═══════════════════════════════════════════════════════════════════════════
  qbit-scheduler:
    build: ./scripts/qbit-scheduler
    container_name: qbit-scheduler
    environment:
      - TZ=${TZ:-Europe/London}
      - QBIT_HOST=${NAS_IP:-192.168.1.100}
      - QBIT_PORT=8085
      - QBIT_USER=${QBIT_USER:-admin}
      - QBIT_PASS=${QBIT_PASSWORD}
      - PAUSE_HOUR=${QBIT_PAUSE_HOUR:-20}
      - RESUME_HOUR=${QBIT_RESUME_HOUR:-6}
    restart: always
    logging: *default-logging
