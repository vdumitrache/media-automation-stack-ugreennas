
#####################################################################
# ⚠️  NEVER use 'docker compose down' - kills Pi-hole DNS!        #
# ⚠️  You WILL lose internet before you can run 'up -d'           #
#                                                                   #
# ✅ Safe restart: docker compose -f docker-compose.arr-stack.yml up -d --force-recreate
# ✅ Or use:       ./scripts/restart-stack.sh                      #
#####################################################################

#########################
# Centralized Volumes   #
#########################
volumes:
  qbittorrent-config:
  sabnzbd-config:
  sonarr-config:
  prowlarr-config:
  radarr-config:
  jellyfin-config:
  jellyfin-cache:
  jellyseerr-config:
  bazarr-config:
  pihole-etc-pihole:
  pihole-etc-dnsmasq:

#########################
# Networks              #
#########################
networks:
  vpn-net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.8.1.0/24
  arr-stack:
    external: true

#########################
# Logging               #
#########################
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

#########################
# Services              #
#########################
services:
  # ═══════════════════════════════════════════════════════════════════════════
  # QBITTORRENT - Torrent download client. Downloads files through VPN.
  # Access: qbit.lan | qbit.yourdomain.com | NAS_IP:8085
  # ═══════════════════════════════════════════════════════════════════════════
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:5.1.4
    container_name: qbittorrent
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - WEBUI_PORT=8085
      - DOCKER_MODS=ghcr.io/vuetorrent/vuetorrent-lsio-mod:latest
    volumes:
      - qbittorrent-config:/config
      - ${MEDIA_ROOT}:/media
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8085/ && wget -q --spider --timeout=5 http://www.google.com"]
      interval: 2m
      timeout: 15s
      retries: 2
      start_period: 60s
    networks:
      arr-stack:
        ipv4_address: 172.20.0.2
    ports:
      - 8085:8085

  # ═══════════════════════════════════════════════════════════════════════════
  # SONARR - TV show monitor. Watches for new episodes and sends to download.
  # Access: sonarr.lan | sonarr.yourdomain.com | NAS_IP:8989
  # ═══════════════════════════════════════════════════════════════════════════
  sonarr:
    image: lscr.io/linuxserver/sonarr:4.0.16
    container_name: sonarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - sonarr-config:/config
      - ${MEDIA_ROOT}/tv:/tv
      - ${MEDIA_ROOT}/downloads:/downloads
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8989/ && wget -q --spider --timeout=5 http://www.google.com"]
      interval: 2m
      timeout: 15s
      retries: 2
      start_period: 60s
    networks:
      arr-stack:
        ipv4_address: 172.20.0.11
    ports:
      - 8989:8989

  # ═══════════════════════════════════════════════════════════════════════════
  # PROWLARR - Indexer manager. Finds download sources for Sonarr/Radarr.
  # Access: prowlarr.lan | prowlarr.yourdomain.com | NAS_IP:9696
  # ═══════════════════════════════════════════════════════════════════════════
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:2.3.0
    container_name: prowlarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - prowlarr-config:/config
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9696/ && wget -q --spider --timeout=5 http://www.google.com"]
      interval: 2m
      timeout: 15s
      retries: 2
      start_period: 60s
    networks:
      arr-stack:
        ipv4_address: 172.20.0.12
    ports:
      - 9696:9696

  # ═══════════════════════════════════════════════════════════════════════════
  # RADARR - Movie monitor. Watches for new movies and sends to download.
  # Access: radarr.lan | radarr.yourdomain.com | NAS_IP:7878
  # ═══════════════════════════════════════════════════════════════════════════
  radarr:
    image: lscr.io/linuxserver/radarr:6.0.4
    container_name: radarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - radarr-config:/config
      - ${MEDIA_ROOT}/movies:/movies
      - ${MEDIA_ROOT}/downloads:/downloads
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:7878/ && wget -q --spider --timeout=5 http://www.google.com"]
      interval: 2m
      timeout: 15s
      retries: 2
      start_period: 60s
    networks:
      arr-stack:
        ipv4_address: 172.20.0.3
    ports:
      - 7878:7878

  # ═══════════════════════════════════════════════════════════════════════════
  # JELLYFIN - Media server. Stream your movies and TV shows like Netflix.
  # Access: jellyfin.lan | jellyfin.yourdomain.com | NAS_IP:8096
  # ═══════════════════════════════════════════════════════════════════════════
  jellyfin:
    image: jellyfin/jellyfin:10.11
    container_name: jellyfin
    ports:
      - "8096:8096"     # Web UI
      - "7359:7359/udp" # Client discovery (auto-detect on LAN)
      - "1900:1900/udp" # DLNA
    environment:
      - TZ=${TZ}
    # Hardware transcoding (Intel Quick Sync) - remove these 4 lines if no Intel GPU
    devices:
      - /dev/dri:/dev/dri
    group_add:
      - "${RENDER_GROUP_ID:-0}"  # Find ID: getent group render | cut -d: -f3
    volumes:
      - jellyfin-config:/config
      - jellyfin-cache:/cache
      - ${MEDIA_ROOT}/movies:/media/movies:ro
      - ${MEDIA_ROOT}/tv:/media/tv:ro
    networks:
      arr-stack:
        ipv4_address: 172.20.0.4
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 1m
      timeout: 30s
      retries: 2
      start_period: 30s

  # ═══════════════════════════════════════════════════════════════════════════
  # PI-HOLE - DNS server. Enables .lan domains and blocks ads network-wide.
  # Access: pihole.lan/admin | NAS_IP:8081/admin
  # For: Home Pro + Anywhere setups
  # ═══════════════════════════════════════════════════════════════════════════
  pihole:
    image: pihole/pihole:2025.11.1
    container_name: pihole
    ports:
      - "${NAS_IP}:53:53/tcp"  # Bind to NAS IP (not 0.0.0.0) to avoid conflict with host dnsmasq on 127.0.0.1:53
      - "${NAS_IP}:53:53/udp"  # NAS_IP MUST be a static IP — DHCP IPs aren't ready at boot, causing exit 128
      - "8081:80"  # Web UI (local network access)
    networks:
      arr-stack:
        ipv4_address: 172.20.0.5
    environment:
      - TZ=${TZ}
      - FTLCONF_webserver_api_password=${PIHOLE_UI_PASS}
      - FTLCONF_dns_listeningMode=all
    volumes:
      - pihole-etc-pihole:/etc/pihole
      - pihole-etc-dnsmasq:/etc/dnsmasq.d
      - ./pihole/02-local-dns.conf:/etc/dnsmasq.d/02-local-dns.conf:ro
    cap_add:
      - NET_ADMIN
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD", "dig", "@127.0.0.1", "-p", "53", "google.com", "+short"]
      interval: 30s
      timeout: 10s
      retries: 2
      start_period: 30s

  # ═══════════════════════════════════════════════════════════════════════════
  # JELLYSEERR - Request portal. Users request movies/shows here.
  # Access: jellyseerr.lan | jellyseerr.yourdomain.com | NAS_IP:5055
  # ═══════════════════════════════════════════════════════════════════════════
  jellyseerr:
    image: fallenbagel/jellyseerr:2.7
    container_name: jellyseerr
    user: "${PUID}:${PGID}"
    ports:
      - "5055:5055"  # Local network access (all interfaces)
    environment:
      - LOG_LEVEL=info
      - TZ=${TZ}
      - PORT=5055
    networks:
      arr-stack:
        ipv4_address: 172.20.0.8
    volumes:
      - /volume2/docker/recipes/media-automation-stack/config/jellyseerr:/app/config
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:5055/api/v1/status"]
      interval: 2m
      timeout: 10s
      retries: 3

  # ═══════════════════════════════════════════════════════════════════════════
  # BAZARR - Subtitle manager. Automatically downloads subtitles.
  # Access: bazarr.lan | bazarr.yourdomain.com | NAS_IP:6767
  # ═══════════════════════════════════════════════════════════════════════════
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    ports:
      - "6767:6767"  # Local network access
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    networks:
      arr-stack:
        ipv4_address: 172.20.0.9
    volumes:
      - bazarr-config:/config
      - ${MEDIA_ROOT}/movies:/movies
      - ${MEDIA_ROOT}/tv:/tv
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6767/"]
      interval: 3m
      timeout: 10s
      retries: 2

  # ═══════════════════════════════════════════════════════════════════════════
  # Cross-seed - Seeds to multiple trackers.
  # Access: bazarr.lan | bazarr.yourdomain.com | NAS_IP:6767
  # ═══════════════════════════════════════════════════════════════════════════
  cross-seed:
    image: ghcr.io/cross-seed/cross-seed:6
    container_name: cross-seed
    user: 1000:1000 # this must match your torrent client (cross-seed does not support using PGID and PUID)
    ports:
      - "2468:2468"  # Local network access
    networks:
      arr-stack:
        ipv4_address: 172.20.0.14
    volumes:
      - /volume2/docker/recipes/media-automation-stack/config/crosseed:/config
      - ${MEDIA_ROOT}:/media
    command: daemon
    restart: unless-stopped
