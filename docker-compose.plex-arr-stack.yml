##############################################################################
# WARNING: UNTESTED CONFIGURATION
# This is a Plex variant of the main stack. It has NOT been tested.
# Use as a reference/starting point only.
#
# If using this instead of the Jellyfin stack, you will also need to:
# 1. Copy traefik/dynamic/vpn-services-plex.yml to vpn-services.yml
# 2. Update scripts/arr-backup.sh if using backups:
#    - Replace jellyfin-config/jellyfin-cache with plex-config
#    - Replace jellyseerr with overseerr
# 3. Add PLEX_CLAIM to .env (see .env.example) - only needed on first run
##############################################################################


#####################################################################
# ⚠️  NEVER use 'docker compose down' - kills Pi-hole DNS!        #
# ⚠️  You WILL lose internet before you can run 'up -d'           #
#                                                                   #
# ✅ Safe restart: docker compose -f docker-compose.plex-arr-stack.yml up -d --force-recreate
# ✅ Or use:       ./scripts/restart-stack.sh                      #
#####################################################################

#########################
# Centralized Volumes   #
#########################
volumes:
  gluetun-config:
  qbittorrent-config:
  sabnzbd-config:
  sonarr-config:
  prowlarr-config:
  radarr-config:
  plex-config:
  overseerr-config:
  bazarr-config:
  pihole-etc-pihole:
  pihole-etc-dnsmasq:
#########################
# Networks              #
#########################
networks:
  vpn-net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.8.1.0/24
  arr-stack:
    external: true

#########################
# Logging               #
#########################
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

#########################
# Services              #
#########################
services:
  # ═══════════════════════════════════════════════════════════════════════════
  # GLUETUN - VPN gateway. Routes download traffic through your VPN provider.
  # All services below marked "via VPN" share this network for privacy.
  # ═══════════════════════════════════════════════════════════════════════════
  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    depends_on:
      pihole:
        condition: service_healthy  # Wait for Pi-hole DNS before VPN connects
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    env_file:
      - .env
    volumes:
      - gluetun-config:/gluetun
    environment:
      # Surfshark VPN Configuration (WireGuard)
      - VPN_SERVICE_PROVIDER=surfshark
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES}
      - SERVER_COUNTRIES=${VPN_COUNTRIES}
      - TZ=${TZ}
      - DNS_ADDRESS=172.20.0.5
      - FIREWALL_OUTBOUND_SUBNETS=${LAN_SUBNET},172.20.0.0/24,10.8.1.0/24
    ports:
      # Ports for services using network_mode: "service:gluetun"
      # Enables direct local access without Traefik (http://NAS_IP:PORT)
      - "8989:8989"   # Sonarr
      - "7878:7878"   # Radarr
      - "9696:9696"   # Prowlarr
      - "8085:8085"   # qBittorrent
      - "8082:8080"   # SABnzbd
    networks:
      arr-stack:
        ipv4_address: 172.20.0.3
      vpn-net:
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD", "/gluetun-entrypoint", "healthcheck"]
      interval: 1m
      timeout: 10s
      retries: 3

  # ═══════════════════════════════════════════════════════════════════════════
  # QBITTORRENT - Torrent download client. Downloads files through VPN.
  # Access: qbit.lan | qbit.yourdomain.com | NAS_IP:8085
  # ═══════════════════════════════════════════════════════════════════════════
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent
    container_name: qbittorrent
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - WEBUI_PORT=8085
      - DOCKER_MODS=ghcr.io/vuetorrent/vuetorrent-lsio-mod:latest
    volumes:
      - qbittorrent-config:/config
      - ${MEDIA_ROOT}/downloads:/downloads
      - ${MEDIA_ROOT}:/media
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8085/ && wget -q --spider --timeout=5 http://www.google.com"]
      interval: 2m
      timeout: 15s
      retries: 2
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════════════════
  # SABNZBD - Usenet download client. Downloads via VPN for extra security.
  # Access: sabnzbd.lan | sabnzbd.yourdomain.com | NAS_IP:8082
  # ═══════════════════════════════════════════════════════════════════════════
  sabnzbd:
    image: lscr.io/linuxserver/sabnzbd:latest
    container_name: sabnzbd
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - sabnzbd-config:/config
      - ${MEDIA_ROOT}/downloads:/downloads
      - ${MEDIA_ROOT}/downloads/incomplete:/incomplete-downloads
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/ && wget -q --spider --timeout=5 http://www.google.com"]
      interval: 3m
      timeout: 15s
      retries: 2
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════════════════
  # SONARR - TV show monitor. Watches for new episodes and sends to download.
  # Access: sonarr.lan | sonarr.yourdomain.com | NAS_IP:8989
  # ═══════════════════════════════════════════════════════════════════════════
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - sonarr-config:/config
      - ${MEDIA_ROOT}/tv:/tv
      - ${MEDIA_ROOT}/downloads:/downloads
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8989/ && wget -q --spider --timeout=5 http://www.google.com"]
      interval: 2m
      timeout: 15s
      retries: 2
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════════════════
  # PROWLARR - Indexer manager. Finds download sources for Sonarr/Radarr.
  # Access: prowlarr.lan | prowlarr.yourdomain.com | NAS_IP:9696
  # ═══════════════════════════════════════════════════════════════════════════
  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - prowlarr-config:/config
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9696/ && wget -q --spider --timeout=5 http://www.google.com"]
      interval: 2m
      timeout: 15s
      retries: 2
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════════════════
  # RADARR - Movie monitor. Watches for new movies and sends to download.
  # Access: radarr.lan | radarr.yourdomain.com | NAS_IP:7878
  # ═══════════════════════════════════════════════════════════════════════════
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
        restart: true
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - radarr-config:/config
      - ${MEDIA_ROOT}/movies:/movies
      - ${MEDIA_ROOT}/downloads:/downloads
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:7878/ && wget -q --spider --timeout=5 http://www.google.com"]
      interval: 2m
      timeout: 15s
      retries: 2
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════════════════
  # PLEX - Media server. Stream your movies and TV shows.
  # Access: plex.lan | plex.yourdomain.com | NAS_IP:32400
  # ═══════════════════════════════════════════════════════════════════════════
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    ports:
      - "32400:32400"  # Local network access
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - VERSION=docker
      - PLEX_CLAIM=${PLEX_CLAIM}  # Get from https://plex.tv/claim (expires in 4 mins)
    volumes:
      - plex-config:/config
      - ${MEDIA_ROOT}/movies:/media/movies:ro
      - ${MEDIA_ROOT}/tv:/media/tv:ro
    networks:
      arr-stack:
        ipv4_address: 172.20.0.4
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:32400/identity"]
      interval: 1m
      timeout: 30s
      retries: 2
      start_period: 30s

  # ═══════════════════════════════════════════════════════════════════════════
  # PI-HOLE - DNS server. Enables .lan domains and blocks ads network-wide.
  # Access: pihole.lan/admin | NAS_IP:8081/admin
  # For: Home Pro + Anywhere setups
  # ═══════════════════════════════════════════════════════════════════════════
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    ports:
      - "${NAS_IP}:53:53/tcp"
      - "${NAS_IP}:53:53/udp"
      - "8081:80"  # Web UI (local network access)
    networks:
      arr-stack:
        ipv4_address: 172.20.0.5
      vpn-net:
        ipv4_address: 10.8.1.200
    environment:
      - TZ=${TZ}
      - FTLCONF_webserver_api_password=${PIHOLE_UI_PASS}
      - FTLCONF_dns_listeningMode=all
    volumes:
      - pihole-etc-pihole:/etc/pihole
      - pihole-etc-dnsmasq:/etc/dnsmasq.d
      - ./pihole/02-local-dns.conf:/etc/dnsmasq.d/02-local-dns.conf:ro
    cap_add:
      - NET_ADMIN
      - SYS_NICE
      - SYS_TIME
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD", "dig", "@127.0.0.1", "-p", "53", "google.com", "+short"]
      interval: 30s
      timeout: 10s
      retries: 2
      start_period: 30s

  # ═══════════════════════════════════════════════════════════════════════════
  # OVERSEERR - Request portal for Plex. Users request movies/shows here.
  # Access: overseerr.lan | overseerr.yourdomain.com | NAS_IP:5055
  # ═══════════════════════════════════════════════════════════════════════════
  overseerr:
    image: lscr.io/linuxserver/overseerr:latest
    container_name: overseerr
    depends_on:
      gluetun:
        condition: service_healthy  # Needs gluetun to reach Sonarr/Radarr
        restart: true
    ports:
      - "5055:5055"  # Local network access
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    networks:
      arr-stack:
        ipv4_address: 172.20.0.8
    volumes:
      - overseerr-config:/config
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:5055/api/v1/status"]
      interval: 2m
      timeout: 10s
      retries: 3

  # ═══════════════════════════════════════════════════════════════════════════
  # BAZARR - Subtitle manager. Automatically downloads subtitles.
  # Access: bazarr.lan | bazarr.yourdomain.com | NAS_IP:6767
  # ═══════════════════════════════════════════════════════════════════════════
  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    depends_on:
      gluetun:
        condition: service_healthy  # Needs gluetun to reach Sonarr/Radarr
        restart: true
    ports:
      - "6767:6767"  # Local network access
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    networks:
      arr-stack:
        ipv4_address: 172.20.0.9
    volumes:
      - bazarr-config:/config
      - ${MEDIA_ROOT}/movies:/movies
      - ${MEDIA_ROOT}/tv:/tv
    restart: always
    logging: *default-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6767/"]
      interval: 3m
      timeout: 10s
      retries: 2

  # ═══════════════════════════════════════════════════════════════════════════
  # FLARESOLVERR - Cloudflare bypass. Helps Prowlarr access protected sites.
  # No web UI. Used internally by Prowlarr at 172.20.0.10:8191
  # ═══════════════════════════════════════════════════════════════════════════
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      - LOG_LEVEL=info
      - TZ=${TZ}
    networks:
      arr-stack:
        ipv4_address: 172.20.0.10
    labels:
      - deunhealth.restart.on.unhealthy=true
    restart: always
    logging: *default-logging
    healthcheck:
      # Actually test Chrome by making a solve request (catches Chrome crashes)
      test: ["CMD", "curl", "-sf", "-X", "POST", "-H", "Content-Type: application/json",
             "-d", "{\"cmd\":\"request.get\",\"url\":\"http://localhost:8191/\",\"maxTimeout\":30000}",
             "http://localhost:8191/v1"]
      interval: 10m
      timeout: 60s
      retries: 2
      start_period: 2m

