# ═══════════════════════════════════════════════════════════════════════════════
# TRAEFIK - Reverse proxy for .lan domains and external access
#
# What it does:
# - Enables .lan domains (e.g., jellyfin.lan) — requires Pi-hole for DNS
# - Enables external access (e.g., jellyfin.yourdomain.com) — requires Cloudflared
#
# SSL: Cloudflare Tunnel handles HTTPS for external access. .lan domains use HTTP.
#
# You DON'T need this for Core setup (IP:port access like 192.168.1.50:8096).
# You DO need this for .lan domains or external access.
#
# Access: traefik.lan | traefik.yourdomain.com | NAS_IP:9090
# ═══════════════════════════════════════════════════════════════════════════════

services:
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: always
    security_opt:
      - no-new-privileges:true
    networks:
      arr-stack:
        ipv4_address: 172.20.0.2
      # macvlan gives Traefik its own LAN IP where it can use port 80
      # (NAS owns port 80 on its IP, but Traefik owns it on TRAEFIK_LAN_IP)
      traefik-lan:
        ipv4_address: ${TRAEFIK_LAN_IP}
        mac_address: ${TRAEFIK_LAN_MAC}
    ports:
      # Dashboard only - HTTP served via macvlan IP on port 80
      - "9090:8080" # Traefik Dashboard
    environment:
      - TZ=${TZ}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/traefik.yml:ro
      - ./traefik/dynamic:/dynamic:ro
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=arr-stack"

      # Dashboard (external access via Cloudflare Tunnel)
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.${DOMAIN}`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=web"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.middlewares=dashboard-auth"

      # Dashboard authentication
      # Generate with: htpasswd -nbB admin 'YOUR_PASSWORD'
      - "traefik.http.middlewares.dashboard-auth.basicauth.users=${TRAEFIK_DASHBOARD_AUTH}"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 30s
      retries: 3
      start_period: 60s

networks:
  arr-stack:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
          ip_range: 172.20.0.128/25
          gateway: 172.20.0.1
  # macvlan network gives Traefik its own IP on your physical LAN
  # This allows Traefik to own port 80/443 (which NAS can't give up)
  traefik-lan:
    driver: macvlan
    driver_opts:
      parent: ${LAN_INTERFACE}  # Network interface - check with: ip link show
    ipam:
      config:
        - subnet: ${LAN_SUBNET}
          gateway: ${LAN_GATEWAY}
